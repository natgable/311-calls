---
title: "New York City in 2010"
author: "Natalie"
date: 2019-03-12
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
library(leaflet)

US_ALBERS <- 
  "+proj=longlat +datum=WGS84 +no_defs"

  # File where generated answers are saved, by default in the home directory
file_nyc_2010 <- "~/Desktop/DCL/C01/nyc/nyc_2010.rds"
nyc_2010 <- read_rds(file_nyc_2010)

police_calls_2010_file <- "~/Desktop/DCL/C01/police_calls/police_calls_2010.rds"
police_calls_2010 <- read_rds(police_calls_2010_file)

nyc_2010_with_calls_file <- 
  "~/Desktop/DCL/C01/nyc_with_calls/nyc_with_calls_2010.rds"
```

# Count the number of calls per tract

```{r}
call_geometries <-
  police_calls_2010 %>% 
  select(Latitude, Longitude) %>% 
  filter(!is.na(Latitude), !is.na(Longitude)) %>% 
  st_as_sf(coords = c("Longitude", "Latitude"), crs = US_ALBERS) %>% 
  st_intersection(nyc_2010$geometry)

calls_per_tract <-
  st_contains(nyc_2010$geometry, call_geometries) %>% 
  as_tibble() %>% 
  group_by(row.id) %>% 
  transmute(
    num_calls = n()
  ) %>% 
  unique()

nyc_2010_with_calls <-
  nyc_2010 %>% 
  mutate(
    num_calls = calls_per_tract$num_calls,
    calls_per_person = if_else(
      condition = (total_pop == 0),
      true = NA_real_,
      false = num_calls/total_pop
    )
  )

write_rds(
  x = nyc_2010_with_calls, 
  path = nyc_2010_with_calls_file, 
  compress = "gz"
)
```

# Make chloropleth

```{r}
labels_2010 <- 
  sprintf(
    "Average Monthly Rent: $%g<br/>Median Household Income: $%g<br/>Percent White: %g<br/>Number of 311 calls: %g",
    round(nyc_2010_with_calls$avg_rent), 
    round(nyc_2010_with_calls$med_income),
    round(100 * nyc_2010_with_calls$percent_white),
    nyc_2010_with_calls$num_calls
  ) %>% 
  lapply(htmltools::HTML)

calls_vals <- 
  colorNumeric(
    palette = "Blues",
    domain = nyc_2010_with_calls$num_calls
  )

leaflet() %>%  
  addProviderTiles(providers$CartoDB.Positron) %>% 
  setView(-73.95, 40.78, 11) %>% 
  addPolygons(
    data = nyc_2010$geometry,
    weight = 1,
    fillOpacity = 1,
    color = calls_vals(nyc_2010_with_calls$num_calls),
    label = labels_2010,
    highlightOptions = highlightOptions(
      color = "red", 
      weight = 3,
      bringToFront = TRUE
    )
  ) %>%
  addLegend(
    "bottomright", 
    pal = calls_vals, 
    values = nyc_2010_with_calls$num_calls,
    title = "Number of calls",
    opacity = 1,
    na.label = element_blank()
  )
```
